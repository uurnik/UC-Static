

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>api.nornir_stuff.configure_nodes &mdash; Uurnik Connect v0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Uurnik Connect
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflow.html">Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../uc-defaults.html">Defaults</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Uuc_api_doc.html">Uurnik Connect API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../known_issues.html">Known Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies &amp; Housekeeping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deployement.html">Deploy Uurnik Connect in Test Environment</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Uurnik Connect</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>api.nornir_stuff.configure_nodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for api.nornir_stuff.configure_nodes</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">api.models</span> <span class="kn">import</span> <span class="n">Hosts</span><span class="p">,</span><span class="n">Defaults</span>
<span class="kn">from</span> <span class="nn">nornir.core.filter</span> <span class="kn">import</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">nornir.plugins.tasks</span> <span class="kn">import</span> <span class="n">networking</span> <span class="p">,</span> <span class="n">text</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">netaddr</span> <span class="kn">import</span> <span class="n">IPNetwork</span>
<span class="kn">import</span> <span class="nn">dns.update</span> <span class="k">as</span> <span class="nn">dnsupdate</span>
<span class="kn">import</span> <span class="nn">dns.query</span> <span class="k">as</span> <span class="nn">dnsquery</span>
<span class="kn">import</span> <span class="nn">dns.resolver</span> <span class="k">as</span> <span class="nn">dnsresolver</span>
<span class="kn">from</span> <span class="nn">netaddr</span> <span class="kn">import</span> <span class="n">IPNetwork</span> <span class="p">,</span><span class="n">IPAddress</span>
<span class="kn">from</span> <span class="nn">ipaddress</span> <span class="kn">import</span> <span class="n">IPv4Interface</span><span class="p">,</span><span class="n">ip_network</span> <span class="p">,</span><span class="n">ip_address</span> <span class="p">,</span><span class="n">ip_interface</span>
<span class="kn">from</span> <span class="nn">ttp</span> <span class="kn">import</span> <span class="n">ttp</span>
<span class="kn">from</span> <span class="nn">scrapli.driver.core</span> <span class="kn">import</span> <span class="n">IOSXEDriver</span>
<span class="kn">from</span> <span class="nn">scrapli.driver</span> <span class="kn">import</span> <span class="n">GenericDriver</span>
<span class="kn">from</span> <span class="nn">netmiko</span> <span class="kn">import</span> <span class="n">file_transfer</span>
<span class="kn">from</span> <span class="nn">nornir_scrapli.tasks</span> <span class="kn">import</span> <span class="n">send_command</span> <span class="k">as</span> <span class="n">scrape_send</span>
<span class="kn">from</span> <span class="nn">nornir_scrapli.tasks</span> <span class="kn">import</span> <span class="n">send_configs</span> <span class="k">as</span> <span class="n">scrape_config</span>
<span class="kn">from</span> <span class="nn">nornir_scrapli.tasks</span> <span class="kn">import</span> <span class="n">send_commands</span> <span class="k">as</span> <span class="n">scrape_config_commands</span>
<span class="kn">from</span> <span class="nn">nornir_scrapli.tasks</span> <span class="kn">import</span> <span class="n">get_prompt</span>
<span class="kn">from</span> <span class="nn">..helpers.misc</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ParseConfig</span><span class="p">,</span>
                            <span class="n">ForigateParser</span><span class="p">,</span>
                            <span class="n">JuniperParser</span><span class="p">,</span>
                            <span class="n">convert_to_cidr</span><span class="p">,</span>
                            <span class="n">get_challenge_pass</span><span class="p">,</span>
                            <span class="n">low_usr_cmds</span><span class="p">,</span>
                            <span class="n">get_interface_index</span><span class="p">,</span>
                            <span class="n">CoppBWCalculator</span> <span class="p">)</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;scrapli.log&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="resolve_host"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.resolve_host">[docs]</a><span class="k">def</span> <span class="nf">resolve_host</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="n">dns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for resolving host fqdn from Uurnik DNS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">my_resolver</span> <span class="o">=</span> <span class="n">dnsresolver</span><span class="o">.</span><span class="n">Resolver</span><span class="p">(</span><span class="n">configure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">my_resolver</span><span class="o">.</span><span class="n">nameservers</span> <span class="o">=</span> <span class="p">[</span><span class="n">dns</span><span class="p">,]</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">my_resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;fqdn&#39;</span><span class="p">],</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">answer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span></div>




<div class="viewcode-block" id="netmiko_direct"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.netmiko_direct">[docs]</a><span class="k">def</span> <span class="nf">netmiko_direct</span><span class="p">(</span><span class="n">task</span> <span class="p">,</span><span class="n">cmd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manually create Netmiko connection, to handle prompts</span>
<span class="sd">    clear ip nat translations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">net_connect</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s2">&quot;netmiko&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">nornir</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">net_connect</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;clear ip nat translation *&quot;</span><span class="p">)</span>
    <span class="n">net_connect</span><span class="o">.</span><span class="n">config_mode</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">net_connect</span><span class="o">.</span><span class="n">send_command_timing</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;entries&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">net_connect</span><span class="o">.</span><span class="n">send_command_timing</span><span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">)</span>
    <span class="n">net_connect</span><span class="o">.</span><span class="n">exit_config_mode</span><span class="p">()</span>
    <span class="n">net_connect</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="scp_file_transfer"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.scp_file_transfer">[docs]</a><span class="k">def</span> <span class="nf">scp_file_transfer</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">net_connect</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s2">&quot;netmiko&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">nornir</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_transfer</span> <span class="o">=</span> <span class="n">file_transfer</span><span class="p">(</span>
                <span class="n">net_connect</span><span class="p">,</span>
                <span class="n">source_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.tcl&quot;</span><span class="p">,</span>
                <span class="n">dest_file</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.tcl&quot;</span><span class="p">,</span>
                <span class="n">file_system</span><span class="o">=</span><span class="s2">&quot;nvram:/&quot;</span><span class="p">,</span>
                <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;put&quot;</span><span class="p">,</span>
                <span class="n">overwrite_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">net_connect</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>



<div class="viewcode-block" id="send_tcl"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.send_tcl">[docs]</a><span class="k">def</span> <span class="nf">send_tcl</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function for transfering the tcl script to schedule ip assignment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Enable SCP server on the Host</span>
    <span class="n">_en_scp</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                    <span class="n">configs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ip scp server enable&quot;</span><span class="p">])</span>
    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

    <span class="c1"># SCP TCL script to the host</span>

    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scp_file_transfer</span><span class="p">)</span>

    <span class="c1"># Parse the template to kron schedule the TCL script on the Host</span>
    <span class="n">parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pasrse tcl schedule template&quot;</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;kro_schedule.jinja2&quot;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/cisco/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Push the config to schedule the TCL script</span>
    <span class="n">kron_schedule</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Load kron schedule&quot;</span><span class="p">,</span>
                <span class="n">configs</span><span class="o">=</span><span class="n">parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kron_schedule</span></div>




<div class="viewcode-block" id="facts"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.facts">[docs]</a><span class="k">def</span> <span class="nf">facts</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function to gather the facts about devices</span>
<span class="sd">    1. Check the device Platform and update Hosts table</span>
<span class="sd">    2. Gather hostname,interfaces,model,serial_no,os_version ,vendor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DOMAIN</span> <span class="o">=</span> <span class="s2">&quot;.uurnikconnect.com&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">GenericDriver</span><span class="p">(</span><span class="n">host</span><span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                        <span class="n">auth_username</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="n">auth_password</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                        <span class="n">timeout_transport</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
                        <span class="n">timeout_socket</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
                        <span class="n">timeout_ops</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>
                        <span class="n">transport</span><span class="o">=</span><span class="s2">&quot;ssh2&quot;</span><span class="p">,</span>
                        <span class="n">auth_strict_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">comms_prompt_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^(\w+.*?)([#\s,&gt;\s,#])$&quot;</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;show version | inc Cisco&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="k">if</span> <span class="s2">&quot;command parse error&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;fortinet&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;cisco nexus&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;nxos&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;cisco ios xr&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;iosxr&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;cisco ios xe&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;ios&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;cisco ios&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;ios&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;junos&quot;</span>



    <span class="k">if</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;junos&quot;</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show version&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scrapli_response</span><span class="o">.</span><span class="n">textfsm_parse_output</span><span class="p">()</span>


        <span class="c1"># get serial number</span>
        <span class="n">get_serial_number</span> <span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;show chassis hardware | grep Chassis&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># get ram size</span>
        <span class="n">get_ram_size</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s1">&#39;show system memory | grep &quot;Total memory&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>



        <span class="n">get_wan_interface</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;show interfaces terse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>


        <span class="n">output</span> <span class="o">=</span> <span class="n">JuniperParser</span><span class="p">(</span><span class="n">get_wan_interface</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;all_interfaces&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">:</span>
                <span class="n">wan_subnet</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">netmask</span>
                <span class="n">wan_interface</span> <span class="o">=</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span>
                <span class="k">break</span>


        <span class="n">get_default_route</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                    <span class="n">command</span><span class="o">=</span><span class="s1">&#39;show route 0.0.0.0 | display json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">get_next_hop</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">get_default_route</span><span class="p">)[</span><span class="s1">&#39;route-information&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;route-table&#39;</span><span class="p">]</span>
        <span class="n">next_hop</span> <span class="o">=</span> <span class="n">get_next_hop</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;rt&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;rt-entry&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;nh&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;to&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="n">get_interface_names</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                    <span class="n">command</span><span class="o">=</span><span class="s1">&#39;show interface terse&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>


        <span class="n">interface_info</span> <span class="o">=</span> <span class="n">JuniperParser</span><span class="p">(</span><span class="n">get_interface_names</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;interface_names&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">interfaces</span> <span class="o">=</span><span class="p">[</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interface_info</span><span class="p">]</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">get_ram_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ram_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">get_ram_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>



        <span class="n">dbHost</span> <span class="o">=</span> <span class="n">Hosts</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">dbHost</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="s2">&quot;Juniper&quot;</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;junos&quot;</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">ram_size</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ram_size</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;MB&#39;</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">serial_no</span> <span class="o">=</span> <span class="n">get_serial_number</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">dev_name</span><span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">model</span><span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">os_version</span><span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;junos_version&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">wan_subnet</span><span class="o">=</span> <span class="n">wan_subnet</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">wan_int</span><span class="o">=</span> <span class="n">wan_interface</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">next_hop</span> <span class="o">=</span> <span class="n">next_hop</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">interfaces</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">fqdn</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DOMAIN</span>

        <span class="n">dbHost</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DOMAIN</span>




    <span class="k">elif</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;fortinet&quot;</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">GenericDriver</span><span class="p">(</span><span class="n">host</span><span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                        <span class="n">auth_username</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                        <span class="n">auth_password</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                        <span class="n">transport</span><span class="o">=</span><span class="s2">&quot;ssh2&quot;</span><span class="p">,</span>
                        <span class="n">auth_strict_key</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">comms_prompt_pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^.*?\s?#\s&quot;</span><span class="p">)</span>

        <span class="n">dbHost</span> <span class="o">=</span> <span class="n">Hosts</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;generic&quot;</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send_commands</span><span class="p">([</span><span class="s2">&quot;config system console&quot;</span> <span class="p">,</span> <span class="s2">&quot;set output standard&quot;</span><span class="p">,</span><span class="s2">&quot;end&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">result</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;get system status&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="c1"># Extract WAN interface Name &amp; Subnet</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">ForigateParser</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;system_info&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output_interface</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get system interface | grep &#39;ip: </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="n">wan_interface</span> <span class="o">=</span> <span class="n">output_interface</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">wan_subnet</span> <span class="o">=</span> <span class="n">output_interface</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Get All Interfaces</span>
        <span class="n">output_interface_all</span><span class="o">=</span><span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get system interface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">all_interfaces</span><span class="o">=</span><span class="n">ForigateParser</span><span class="p">(</span><span class="n">output_interface_all</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;all_interfaces&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">interface_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">all_interfaces</span> <span class="p">]</span>

        <span class="c1"># Get Next-Hop from default route</span>
        <span class="n">next_hop_output</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;get router info routing-table static&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">next_hop_default</span> <span class="o">=</span> <span class="n">ForigateParser</span><span class="p">(</span><span class="n">next_hop_output</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;default_next_hop&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get total RAM size</span>
        <span class="n">get_ram_size</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s2">&quot;get system performance status | grep Memory:&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ram_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_ram_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


        <span class="c1"># If device is a hub then add to NHS list</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HUB&quot;</span><span class="p">:</span>
            <span class="n">defaultsDB</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dbHost</span><span class="o">.</span><span class="n">tunnel_ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaultsDB</span><span class="o">.</span><span class="n">nhs_server</span><span class="p">:</span>
                <span class="n">defaultsDB</span><span class="o">.</span><span class="n">hubs_fqds</span> <span class="o">=</span> <span class="n">defaultsDB</span><span class="o">.</span><span class="n">hubs_fqds</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">dbHost</span><span class="o">.</span><span class="n">fqdn</span>
                <span class="n">defaultsDB</span><span class="o">.</span><span class="n">nhs_server</span> <span class="o">=</span> <span class="n">defaultsDB</span><span class="o">.</span><span class="n">nhs_server</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tunnel_ip&#39;</span><span class="p">]</span>
                <span class="n">defaultsDB</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


        <span class="c1"># Save facts to DB</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">ram_size</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ram_size</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;MB&quot;</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">wan_int</span> <span class="o">=</span>  <span class="n">wan_interface</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="s2">&quot;Fortinet&quot;</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">wan_subnet</span><span class="o">=</span> <span class="n">wan_subnet</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">next_hop</span><span class="o">=</span> <span class="n">next_hop_default</span><span class="p">[</span><span class="s1">&#39;next_hop&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">interfaces</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">interface_list</span><span class="p">)</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">serial_no</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;serial_no&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">os_version</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;os_version&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">fqdn</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DOMAIN</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DOMAIN</span>



    <span class="k">elif</span> <span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;ios&quot;</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span> <span class="o">=</span> <span class="n">networking</span><span class="o">.</span><span class="n">napalm_get</span><span class="p">,</span>
                    <span class="n">getters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;facts&quot;</span><span class="p">])</span>
        <span class="n">facts_device</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;napalm&quot;</span><span class="p">)</span>

        <span class="c1">#Get RAM size</span>
        <span class="c1"># version = task.run(task=scrape_send,</span>
        <span class="c1">#                 command=&quot;show version | inc bytes of memory&quot;).result      </span>

        <span class="c1"># expression =r&quot;\d*?K/\d*?K&quot;</span>

        <span class="c1"># pattern = re.compile(expression)</span>
        <span class="c1"># memory=pattern.findall(version)[0].split(&quot;/&quot;)</span>

        <span class="c1"># left_one = int(memory[0].strip(&quot;K&quot;))</span>
        <span class="c1"># right_one = int(memory[1].strip(&quot;K&quot;))</span>
        <span class="c1"># ram_size = round((left_one + right_one) / 1024)</span>
        <span class="n">ram_size</span><span class="o">=</span><span class="mi">1024</span>


        <span class="c1"># Get WAN interface</span>
        <span class="n">get_interface</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Get interface&quot;</span><span class="p">,</span>
                        <span class="n">command</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;show ip interface brief | inc </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;wan_int&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_interface</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get WAN interface subnet</span>
        <span class="n">get_wan_subnet</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Get interface Subnet&quot;</span><span class="p">,</span>
                            <span class="n">command</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;show interfaces </span><span class="si">{</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;wan_int&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">  | inc  Internet address&quot;</span><span class="p">)</span>
        <span class="n">netmask</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="n">get_wan_subnet</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="s2">&quot;wan_int_subnet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">netmask</span><span class="o">.</span><span class="n">netmask</span><span class="p">)</span>

        <span class="c1"># Get nexthop from the device (by parsing out default route)</span>
        <span class="n">get_next_hop</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;GET NEXT HOP FOR DEFAULT ROUTE&quot;</span><span class="p">,</span>
                        <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | inc ip route 0.0.0.0 0.0.0.0&quot;</span><span class="p">)</span>
        <span class="n">next_hop</span> <span class="o">=</span>  <span class="n">get_next_hop</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># Close SSH connection manually</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

        <span class="c1"># Save facts to Database</span>
        <span class="n">dbHost</span> <span class="o">=</span> <span class="n">Hosts</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">dbHost</span><span class="o">.</span><span class="n">wan_int</span> <span class="o">=</span> <span class="n">get_interface</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">wan_subnet</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="s2">&quot;wan_int_subnet&quot;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">next_hop</span> <span class="o">=</span> <span class="n">next_hop</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">ram_size</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ram_size</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;MB&#39;</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span>


        <span class="n">dbHost</span><span class="o">.</span><span class="n">os_version</span> <span class="o">=</span> <span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;os_version&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>




        <span class="n">dbHost</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;vendor&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">serial_no</span> <span class="o">=</span><span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;serial_number&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">interfaces</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;interface_list&#39;</span><span class="p">])</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">fqdn</span> <span class="o">=</span> <span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DOMAIN</span>


        <span class="n">defaultsDB</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HUB&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dbHost</span><span class="o">.</span><span class="n">fqdn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">defaultsDB</span><span class="o">.</span><span class="n">hubs_fqds</span><span class="p">:</span>
                <span class="n">defaultsDB</span><span class="o">.</span><span class="n">hubs_fqds</span> <span class="o">=</span> <span class="n">defaultsDB</span><span class="o">.</span><span class="n">hubs_fqds</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="n">dbHost</span><span class="o">.</span><span class="n">fqdn</span>


        <span class="n">defaultsDB</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">dbHost</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">facts_device</span><span class="p">[</span><span class="s1">&#39;facts&#39;</span><span class="p">][</span><span class="s1">&#39;hostname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">DOMAIN</span></div>



<div class="viewcode-block" id="device_harderning"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.device_harderning">[docs]</a><span class="k">def</span> <span class="nf">device_harderning</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function for building &amp; pushing device hardening commands to hosts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">running_config</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;show running-config&quot;</span><span class="p">)</span>
    <span class="n">interface_config</span> <span class="o">=</span> <span class="n">ParseConfig</span><span class="p">(</span><span class="n">running_config</span><span class="o">.</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">temp</span><span class="o">=</span><span class="s2">&quot;interfaces&quot;</span><span class="p">)</span>
    <span class="n">logical_interfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interface_config</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s1">&#39;Loop&#39;</span> <span class="ow">in</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;Tunnel&#39;</span> <span class="ow">in</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]:</span>
            <span class="n">logical_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">])</span>


    <span class="n">total_ram_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ram_size&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;MB&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span>
    <span class="n">reserve_mem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_ram_size</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.25</span><span class="p">))</span>
    <span class="n">reserve_mem</span> <span class="o">=</span> <span class="n">total_ram_size</span> <span class="o">-</span> <span class="n">reserve_mem</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="s1">&#39;hardening_cisco.jinja2&#39;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="s1">&#39;api/nornir_stuff/templates/cisco&#39;</span><span class="p">,</span>
                    <span class="n">interfaces</span><span class="o">=</span><span class="n">interfaces</span><span class="p">,</span>
                    <span class="n">logical_interfaces</span><span class="o">=</span><span class="n">logical_interfaces</span><span class="p">,</span>
                    <span class="n">reserve_mem</span> <span class="o">=</span> <span class="n">reserve_mem</span><span class="p">)</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>

    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;push hardening configs&#39;</span><span class="p">,</span>
            <span class="n">configs</span> <span class="o">=</span> <span class="n">commands</span><span class="p">)</span>

    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="configure_copp"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.configure_copp">[docs]</a><span class="k">def</span> <span class="nf">configure_copp</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function parses the COPP template and push commands to hosts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">copp_bw</span> <span class="o">=</span> <span class="n">CoppBWCalculator</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;copp_bw&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>


    <span class="n">config</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;copp_cisco_template.jinja2&#39;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="s1">&#39;api/nornir_stuff/templates/cisco&#39;</span><span class="p">,</span>
                        <span class="n">copp_bw</span><span class="o">=</span><span class="n">copp_bw</span><span class="p">)</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span> <span class="s2">&quot;push copp configuration&quot;</span><span class="p">,</span>
            <span class="n">configs</span> <span class="o">=</span> <span class="n">commands</span><span class="p">)</span>

    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="conf_dmvpn"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.conf_dmvpn">[docs]</a><span class="k">def</span> <span class="nf">conf_dmvpn</span><span class="p">(</span><span class="n">task</span> <span class="p">,</span><span class="n">nr</span><span class="p">,</span><span class="n">dia</span><span class="p">,</span><span class="n">other_services</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span><span class="n">dns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function is performing the following tasks</span>
<span class="sd">        1. Create configuration backup on control node, configurations are saved to api/backup_configs</span>
<span class="sd">        2. Enable archive feature to create a backup of running-config of Host locally</span>
<span class="sd">        3. Extract WAN interface name from given IP</span>
<span class="sd">        4. Get WAN interface subnet &amp; nexthop from default route</span>
<span class="sd">        5. Update inventory</span>
<span class="sd">        6. Build configuration template for both HUBS &amp; SPOKES</span>
<span class="sd">        7. Push configs to devices</span>
<span class="sd">        8. Get SNMP interface Index of Tunnel414</span>
<span class="sd">        9. Update DNS</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">################################## Juniper Configuration Starts ###########################################</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;junos&quot;</span><span class="p">:</span>

        <span class="n">get_interfaces</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show interfaces terse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">interfaces</span> <span class="o">=</span> <span class="n">JuniperParser</span><span class="p">(</span><span class="n">get_interfaces</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;all_interfaces&quot;</span><span class="p">)</span>

        <span class="n">advertised_interfaces</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">interface_network</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">network</span>
            <span class="n">subnet_mask</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">netmask</span>
            <span class="n">interface_network</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interface_network</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">subnet_mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">route</span> <span class="o">==</span> <span class="n">interface_network</span><span class="p">:</span>
                    <span class="n">advertised_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">])</span>

        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;advertised_int&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">advertised_interfaces</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="s1">&#39;advpn.jinja2&#39;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;api/nornir_stuff/templates/juniper/</span><span class="si">{</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">lan_interfaces</span><span class="o">=</span><span class="n">advertised_interfaces</span><span class="p">)</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Push juniper configs&quot;</span><span class="p">,</span>
                <span class="n">configs</span><span class="o">=</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s1">&#39;scrapli&#39;</span><span class="p">)</span>


    <span class="c1">################################# Fortigate Configuration Starts ####################################</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;generic&quot;</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">facts</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">get_prompt</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config_commands</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;set console length&#39;</span><span class="p">,</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;config system console&quot;</span><span class="p">,</span><span class="s2">&quot;set output standard&quot;</span> <span class="p">,</span><span class="s2">&quot;end&quot;</span><span class="p">])</span>

        <span class="c1">#Backup full configuration</span>
        <span class="n">get_config</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show full-configuration&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s2">/api/backup_configs/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.cfg&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_config</span><span class="p">)</span>


        <span class="n">connect_routes</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                            <span class="n">command</span><span class="o">=</span><span class="s2">&quot;get system interface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>
        <span class="n">interface_parser</span> <span class="o">=</span> <span class="n">ForigateParser</span><span class="p">(</span><span class="n">connect_routes</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;interface_attr&quot;</span><span class="p">)</span>

        <span class="n">advertised_interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interface_parser</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;169.254&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ip</span> <span class="ow">and</span> <span class="s2">&quot;0.0.0.0&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ip</span><span class="p">:</span>
                <span class="n">interface_network</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">network</span>
                <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interface_network</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="n">route</span><span class="p">:</span>
                        <span class="n">advertised_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;advertised_int&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">advertised_interfaces</span>


        <span class="n">config</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="s1">&#39;advpn_main.jinja2&#39;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;api/nornir_stuff/templates/fortigate/</span><span class="si">{</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">advertised_interfaces</span><span class="o">=</span><span class="n">advertised_interfaces</span><span class="p">)</span>

        <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config_commands</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forigate advpn config&#39;</span><span class="p">,</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="n">commands</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">dnsupdate</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="s1">&#39;uurnikconnect.com&#39;</span><span class="p">)</span>
            <span class="n">update</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dev_name&quot;</span><span class="p">],</span><span class="mi">300</span><span class="p">,</span><span class="s2">&quot;A&quot;</span> <span class="p">,</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">_response</span> <span class="o">=</span> <span class="n">dnsquery</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="n">update</span><span class="p">,</span><span class="n">dns</span> <span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c1">###################################################################################################</span>


    <span class="c1">################################## Cisco Configuration Starts #####################################</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;ios&quot;</span><span class="p">:</span>
        <span class="c1"># Get running configuration of the Host &amp; save it the backup_configs directory</span>
        <span class="c1"># task.run(task=facts)</span>

        <span class="n">get_configs</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Backup configurations&quot;</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show running-config&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s2">/api/backup_configs/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.cfg&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">get_configs</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

        <span class="c1">#Enable Archive feature on the device to create a configuration backup on the device</span>
        <span class="c1"># parse_archive = task.run(task=text.template_file,</span>
        <span class="c1">#                 name=&quot;Parse archive_en template&quot;,</span>
        <span class="c1">#                 template=&quot;archive_en.jinja2&quot;,</span>
        <span class="c1">#                 path=f&quot;api/nornir_stuff/templates/cisco&quot;)</span>
        <span class="c1"># task.host[&quot;archive&quot;] = parse_archive.result</span>

        <span class="c1"># _en_archive = task.run(task=scrape_config,</span>
        <span class="c1">#                 name=&quot;Push archive config&quot;,</span>
        <span class="c1">#                 configs= parse_archive.result.splitlines())</span>



        <span class="c1"># # Create a list of Spoke Networks</span>
        <span class="n">spokes_tunnel</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">loop_backs</span><span class="o">=</span> <span class="p">[]</span>
        <span class="n">spoke_networks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">custom_routes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spokes</span> <span class="o">=</span> <span class="n">nr</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="n">groups__contains</span><span class="o">=</span><span class="s2">&quot;SPOKE&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">spokes</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">hosts</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">spokes_tunnel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spokes</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tunnel_ip&quot;</span><span class="p">])</span>
            <span class="n">loop_backs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spokes</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;loop_back&quot;</span><span class="p">])</span>
            <span class="n">spoke_networks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spokes</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">])</span>
            <span class="n">custom_routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spokes</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;custom_routes&#39;</span><span class="p">])</span>

        <span class="n">spoke_networks</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">spoke_networks</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">custom_routes</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">custom_routes</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="c1">######################################################################</span>
        <span class="n">advertised_routes</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span>

        <span class="n">interface_parser</span> <span class="o">=</span> <span class="n">ParseConfig</span><span class="p">(</span><span class="n">get_configs</span><span class="o">.</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="s2">&quot;interfaces&quot;</span><span class="p">)</span>
        <span class="n">all_interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interface_parser</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

        <span class="n">advertised_interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">all_interfaces</span><span class="p">:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
            <span class="n">interface_network</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">network</span>
            <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">advertised_routes</span><span class="p">:</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interface_network</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="n">route</span><span class="p">:</span>
                    <span class="n">advertised_interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;advertised_int&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">interface_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;interface&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">interface_name</span> <span class="ow">in</span> <span class="n">advertised_interfaces</span> <span class="p">]</span>

        <span class="n">get_static</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | inc ip route&quot;</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="s1">&#39;static_routes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_static</span><span class="o">.</span><span class="n">result</span>



        <span class="n">routes_to_change</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">get_static</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">advertised_route</span> <span class="ow">in</span> <span class="n">advertised_routes</span><span class="p">:</span>
                    <span class="n">static_route</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">static_route</span> <span class="o">==</span> <span class="n">advertised_route</span><span class="p">:</span>
                        <span class="n">routes_to_change</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
        <span class="c1">#########################################################################</span>
        <span class="n">spoke_networks_all</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">loop_backs</span><span class="p">,</span><span class="n">spoke_networks</span><span class="p">,</span><span class="n">custom_routes</span><span class="p">)</span>
        
        <span class="c1"># Get only connected networks and interface IP</span>
        <span class="n">connected_networks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;advertised_int&#39;</span><span class="p">]:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                        <span class="n">command</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;show interface </span><span class="si">{</span><span class="n">interface</span><span class="si">}</span><span class="s2"> | inc Internet address&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">network</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">IPNetwork</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">network</span><span class="p">)</span>
            <span class="n">connected_networks</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;network&quot;</span><span class="p">:</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">mask</span> <span class="p">,</span> <span class="s2">&quot;ip&quot;</span><span class="p">:</span><span class="n">ip</span><span class="p">})</span>

        <span class="c1"># ######################################################   </span>

        <span class="c1"># Parse the main confiuguration template</span>
        <span class="n">parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Base Configuration&quot;</span><span class="p">,</span>
                        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;mytemplate.jinja2&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/cisco/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">spokes_tunnel</span><span class="p">,</span>
                        <span class="n">loop_backs</span> <span class="o">=</span> <span class="n">loop_backs</span><span class="p">,</span>
                        <span class="n">spoke_networks</span><span class="o">=</span><span class="n">spoke_networks</span><span class="p">,</span>
                        <span class="n">custom_routes</span><span class="o">=</span><span class="n">custom_routes</span><span class="p">,</span>
                        <span class="n">dia</span><span class="o">=</span><span class="n">dia</span><span class="p">,</span>
                        <span class="n">dns</span><span class="o">=</span><span class="n">dns</span><span class="p">,</span>
                        <span class="n">other_services</span><span class="o">=</span><span class="n">other_services</span><span class="p">,</span>
                        <span class="n">low_usr_cmds</span><span class="o">=</span><span class="n">low_usr_cmds</span><span class="p">,</span>
                        <span class="n">connected_networks</span><span class="o">=</span><span class="n">connected_networks</span><span class="p">)</span>


        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_template</span><span class="o">.</span><span class="n">result</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>

        <span class="c1"># Push config</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Loading configuration&quot;</span><span class="p">,</span>
                    <span class="n">configs</span><span class="o">=</span> <span class="n">config</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

        <span class="c1"># configure device hardening and COPP if already deployed on network</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_device_hardening_configured&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">device_harderning</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_copp_configured&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">configure_copp</span><span class="p">)</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Push NAT configuration on the Host according to the access type</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SPOKE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dia</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="ow">or</span> <span class="n">other_services</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Configure NAT on WAN&quot;</span><span class="p">,</span>
                        <span class="n">configs</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;int </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wan_int&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;ip nat outside&quot;</span><span class="p">])</span>



        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HUB&quot;</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Configure NAT on WAN&quot;</span><span class="p">,</span>
                    <span class="n">configs</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;int </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wan_int&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;ip nat outside&quot;</span><span class="p">])</span>

        <span class="c1">#####################################################################</span>
        <span class="k">if</span> <span class="n">dia</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SPOKE&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ip_nat_parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                                    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;ip_nat_inside.jinja2&quot;</span><span class="p">,</span>
                                    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;api/nornir_stuff/templates/cisco&quot;</span><span class="p">,</span>
                                    <span class="n">advertised_interfaces</span><span class="o">=</span><span class="n">advertised_interfaces</span><span class="p">)</span>

            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;NAT inside configuration&quot;</span><span class="p">,</span>
                    <span class="n">configs</span><span class="o">=</span> <span class="n">ip_nat_parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>



        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SPOKE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">other_services</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">vrf_parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                                    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;configure_vrf_LAN.jinja2&quot;</span><span class="p">,</span>
                                    <span class="n">path</span><span class="o">=</span><span class="s2">&quot;api/nornir_stuff/templates/cisco/SPOKE&quot;</span><span class="p">,</span>
                                    <span class="n">advertised_interfaces</span><span class="o">=</span><span class="n">advertised_interfaces</span><span class="p">)</span>

                <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vrf LAN configuration&quot;</span><span class="p">,</span>
                        <span class="n">configs</span><span class="o">=</span> <span class="n">vrf_parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">routes_to_change</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">static_route_vrf_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                                                <span class="n">template</span><span class="o">=</span><span class="s2">&quot;change_static_route.jinja2&quot;</span><span class="p">,</span>
                                                <span class="n">path</span><span class="o">=</span><span class="s2">&quot;api/nornir_stuff/templates/cisco&quot;</span><span class="p">,</span>
                                                <span class="n">routes_to_change</span><span class="o">=</span><span class="n">routes_to_change</span><span class="p">)</span>

                    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vrf LAN route configuration&quot;</span><span class="p">,</span>
                            <span class="n">configs</span><span class="o">=</span> <span class="n">static_route_vrf_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1">####################################################################</span>

        <span class="c1"># Create TCL script with Host name as the filename of the TCL script, SCP to the Host and schedule to assign vrf and put IP address again</span>
        <span class="k">if</span> <span class="n">dia</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span> <span class="ow">and</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SPOKE&quot;</span><span class="p">:</span>
            <span class="n">tcl_script</span> <span class="o">=</span><span class="sa">f</span><span class="s1">&#39;tclsh</span><span class="se">\n</span><span class="s1"> ios_config &quot;interface </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;wan_int&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; &quot;ip vrf forwarding INTERNET&quot; &quot;ip address </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;wan_subnet&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; &quot;exit&quot; &quot;interface tunnel 414&quot; &quot;shutdown&quot; &quot;no shutdown&quot; </span><span class="se">\n</span><span class="s1"> tclquit&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.tcl&quot;</span> <span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tcl_script</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">send_tcl</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.tcl&quot;</span><span class="p">)</span>
        

        <span class="c1"># get snmp interface index (1.3.6.1.2.1.2.2.1.2.x)</span>
        <span class="n">interface_index</span> <span class="o">=</span> <span class="n">get_interface_index</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span> <span class="p">,</span> <span class="s2">&quot;public&quot;</span> <span class="p">,</span><span class="s2">&quot;Tunnel414&quot;</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;interface_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interface_index</span>

        <span class="c1">#Update dns server</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">dnsupdate</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="s1">&#39;uurnikconnect.com&#39;</span><span class="p">)</span>
            <span class="n">update</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;dev_name&quot;</span><span class="p">],</span><span class="mi">300</span><span class="p">,</span><span class="s2">&quot;A&quot;</span> <span class="p">,</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
            <span class="n">_response</span> <span class="o">=</span> <span class="n">dnsquery</span><span class="o">.</span><span class="n">tcp</span><span class="p">(</span><span class="n">update</span><span class="p">,</span><span class="n">dns</span> <span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">spoke_networks_all</span><span class="p">)</span></div>
    <span class="c1">##################################################################################################</span>





<div class="viewcode-block" id="remove_hosts"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.remove_hosts">[docs]</a><span class="k">def</span> <span class="nf">remove_hosts</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function for defining the method to remove configuration on Hosts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the access type</span>
    <span class="n">option</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;access_type&#39;</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;junos&quot;</span><span class="p">:</span>
        <span class="n">parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Parse Juniper Configuration removal&quot;</span><span class="p">,</span>
                        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;remove_config.jinja2&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/juniper/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Remove Configuration&quot;</span><span class="p">,</span>
                <span class="n">configs</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>



    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;generic&quot;</span><span class="p">:</span>
        <span class="n">parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Prarse Fortigate Configuration removal&quot;</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;remove_config.jinja2&quot;</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/fortigate/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config_commands</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Remove Configuration&quot;</span><span class="p">,</span>
                <span class="n">commands</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>



    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;ios&quot;</span><span class="p">:</span>
        <span class="n">get_interface</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | sec interface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="n">interface_parser</span> <span class="o">=</span> <span class="n">ParseConfig</span><span class="p">(</span><span class="n">get_interface</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">temp</span><span class="o">=</span><span class="s2">&quot;interfaces&quot;</span><span class="p">)</span>

        <span class="n">advertised_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interface_parser</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">advertised_interface</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;advertised_interfaces&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">interface</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">advertised_interface</span><span class="p">:</span>
                    <span class="n">ip</span> <span class="o">=</span> <span class="n">interface</span><span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">]</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">interface</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span>
                    <span class="n">advertised_int</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">interface</span><span class="p">[</span><span class="s2">&quot;interface&quot;</span><span class="p">]</span> <span class="p">,</span><span class="s2">&quot;ip&quot;</span><span class="p">:</span><span class="n">ip</span> <span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">:</span><span class="n">mask</span><span class="p">})</span>


        <span class="n">get_static</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | inc ip route&quot;</span><span class="p">)</span>

        <span class="n">routes</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;routes&quot;</span><span class="p">]</span>
        <span class="n">static_routes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SPOKE&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">static_route</span> <span class="ow">in</span> <span class="n">get_static</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">static_route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">static_route</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s2">&quot;vrf LAN&quot;</span> <span class="ow">in</span> <span class="n">static_route</span><span class="p">:</span>
                                <span class="n">static</span><span class="o">=</span> <span class="n">static_route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                                <span class="n">static_routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">static</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">static</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">static</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">static_route</span> <span class="ow">in</span> <span class="n">get_static</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">static_route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">static_route</span><span class="p">:</span>
                            <span class="n">static</span><span class="o">=</span> <span class="n">static_route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                            <span class="n">static_routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">static</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">static</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">static</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="c1"># Parse the remove config template</span>
        <span class="n">parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Base Configuration&quot;</span><span class="p">,</span>
                        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;remove_config.jinja2&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/cisco&quot;</span><span class="p">,</span>
                        <span class="n">option</span><span class="o">=</span><span class="n">option</span><span class="p">,</span>
                        <span class="n">advertised_int</span><span class="o">=</span><span class="n">advertised_int</span><span class="p">,</span>
                        <span class="n">static_routes</span><span class="o">=</span><span class="n">static_routes</span><span class="p">,</span>
                        <span class="n">low_usr_cmds</span><span class="o">=</span><span class="n">low_usr_cmds</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>

        <span class="c1"># Push the remove config to the Host</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Remove Configuration from Spoke&quot;</span><span class="p">,</span>
                <span class="n">configs</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

        <span class="c1"># Run the netmiko direct function which will first remove the NAT translations and then remove ip nat configuration</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPOKE&#39;</span> <span class="ow">and</span> <span class="n">option</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;no ip nat inside source list uurnik interface </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wan_int&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> overload&quot;</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">netmiko_direct</span> <span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">cmd</span><span class="p">)</span>


        <span class="c1"># Check if COPP is configured ,if yes then remove COPP configuration</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_copp_configured&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;api/nornir_stuff/templates/cisco/remove_copp.txt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file_data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">commands</span> <span class="o">=</span><span class="p">[</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">file_data</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="p">]</span>
                <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
                        <span class="n">configs</span> <span class="o">=</span> <span class="n">commands</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Create a TCL script to remove the INTERNET vrf and put ip address on that interface again</span>
        <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SPOKE&quot;</span><span class="p">:</span>
                    <span class="n">tcl_script</span> <span class="o">=</span><span class="sa">f</span><span class="s1">&#39;tclsh</span><span class="se">\n</span><span class="s1"> ios_config &quot;interface </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;wan_int&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; &quot;no ip vrf forwarding INTERNET&quot; &quot;ip address </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;wan_subnet&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; &quot;exit&quot; &quot;no ip vrf INTERNET 0.0.0.0 0.0.0.0 </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;next_hop&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot; &quot;no ip vrf INTERNET&quot;</span><span class="se">\n</span><span class="s1">tclquit &#39;</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;.tcl&quot;</span> <span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tcl_script</span><span class="p">)</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">send_tcl</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.tcl&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="change_on_spoke"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.change_on_spoke">[docs]</a><span class="k">def</span> <span class="nf">change_on_spoke</span><span class="p">(</span><span class="n">task</span> <span class="p">,</span><span class="n">option</span> <span class="p">,</span><span class="n">hub_tunnel_ip</span> <span class="p">,</span> <span class="n">hub_nbma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function to add static hub mapping &amp; BGP neighborship</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                <span class="n">template</span><span class="o">=</span><span class="s2">&quot;add_hub.jinja2&quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/cisco/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">hub_tunnel_ip</span><span class="o">=</span><span class="n">hub_tunnel_ip</span><span class="p">,</span>
                <span class="n">hub_nbma</span><span class="o">=</span><span class="n">hub_nbma</span><span class="p">,</span>
                <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">)</span>


    <span class="n">configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>
    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;add nhs entry &amp; bgp neighborship&quot;</span><span class="p">,</span>
            <span class="n">configs</span><span class="o">=</span><span class="n">configs</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="remove_hub_from_spoke"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.remove_hub_from_spoke">[docs]</a><span class="k">def</span> <span class="nf">remove_hub_from_spoke</span><span class="p">(</span><span class="n">task</span> <span class="p">,</span><span class="n">option</span><span class="p">,</span> <span class="n">hub_tunnel_ip</span><span class="p">,</span><span class="n">hub_nbma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function to remove static hub mapping &amp; BGP neighborship</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                <span class="n">template</span><span class="o">=</span><span class="s2">&quot;remove_hub.jinja2&quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/cisco/</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">hub_tunnel_ip</span><span class="o">=</span><span class="n">hub_tunnel_ip</span><span class="p">,</span>
                <span class="n">hub_nbma</span><span class="o">=</span><span class="n">hub_nbma</span><span class="p">,</span>
                <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">)</span>

    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;remove nhs entry &amp; bgp neighborship&quot;</span><span class="p">,</span>
            <span class="n">configs</span><span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>




<div class="viewcode-block" id="conf_ip_sla"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.conf_ip_sla">[docs]</a><span class="k">def</span> <span class="nf">conf_ip_sla</span><span class="p">(</span><span class="n">task</span> <span class="p">,</span><span class="n">track_ip</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function to configure ip sla and hsrp tracking</span>

<span class="sd">        :params:</span>
<span class="sd">            track_ip: ip to track for sla</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ospf_is_routing_proto</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                           <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | inc router ospf&quot;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ospf_is_routing_proto</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ospf</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ospf_proc_id</span> <span class="o">=</span> <span class="n">ospf_is_routing_proto</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ospf</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ospf_proc_id</span> <span class="o">=</span><span class="kc">False</span>



    <span class="n">eigrp_is_routing_proto</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                           <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | inc router eigrp&quot;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eigrp_is_routing_proto</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">eigrp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">eigrp_as_num</span> <span class="o">=</span> <span class="n">eigrp_is_routing_proto</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eigrp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">eigrp_as_num</span> <span class="o">=</span><span class="kc">False</span>


    <span class="n">rip_routing_proto</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | inc router rip&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rip_routing_proto</span><span class="o">.</span><span class="n">result</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rip</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rip</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">r</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                <span class="n">template</span><span class="o">=</span><span class="s1">&#39;ip_sla.jinja2&#39;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/cisco&quot;</span><span class="p">,</span>
                <span class="n">track_ip</span><span class="o">=</span><span class="n">track_ip</span><span class="p">,</span>
                <span class="n">ospf</span><span class="o">=</span> <span class="n">ospf</span><span class="p">,</span>
                <span class="n">ospf_proc_id</span><span class="o">=</span><span class="n">ospf_proc_id</span><span class="p">,</span>
                <span class="n">eigrp</span><span class="o">=</span><span class="n">eigrp</span><span class="p">,</span>
                <span class="n">eigrp_as_num</span> <span class="o">=</span> <span class="n">eigrp_as_num</span><span class="p">,</span>
                <span class="n">rip</span><span class="o">=</span><span class="n">rip</span><span class="p">)</span>

    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span> <span class="p">]</span>

    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;configure ip sla and hsrp tracking&quot;</span><span class="p">,</span>
            <span class="n">configs</span><span class="o">=</span> <span class="n">config</span><span class="p">)</span>

    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>







<div class="viewcode-block" id="fetch_cdp_data"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.fetch_cdp_data">[docs]</a><span class="k">def</span> <span class="nf">fetch_cdp_data</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function to get CDP Neighbors information</span>
<span class="sd">    by exec &quot;show cdp neighbors&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show cdp neighbors&quot;</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_routing_table_cisco"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.get_routing_table_cisco">[docs]</a><span class="k">def</span> <span class="nf">get_routing_table_cisco</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show ip route&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">scrapli_response</span><span class="o">.</span><span class="n">textfsm_parse_output</span><span class="p">()</span></div>



<div class="viewcode-block" id="get_routes"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.get_routes">[docs]</a><span class="k">def</span> <span class="nf">get_routes</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ( Cisco devices)</span>
<span class="sd">        1. Get &#39;Show run | sec interface&#39; output</span>
<span class="sd">        2. Get &#39;Show run | inc ip route&#39; output</span>
<span class="sd">    (Fortigate devices)</span>
<span class="sd">        1. Get &quot;get system interface&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#for juniper</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;junos&quot;</span><span class="p">:</span>
        <span class="n">get_interfaces</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show interfaces terse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="n">connected_interfaces</span> <span class="o">=</span> <span class="n">JuniperParser</span><span class="p">(</span><span class="n">get_interfaces</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;all_interfaces&quot;</span><span class="p">)</span>

        <span class="n">routes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">connected_interfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ip_address</span><span class="p">(</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">is_private</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;127.0.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]:</span>
                    <span class="n">route</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">network</span>
                    <span class="n">cidr</span> <span class="o">=</span> <span class="n">interface</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">route_f</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">route</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">cidr</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route_f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">routes</span>



    <span class="c1"># for Cisco</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;ios&quot;</span><span class="p">:</span>
        <span class="n">connect_routes</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                            <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | sec interface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="n">static_routes</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                            <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show run | inc ip route&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="n">dynamic_routes</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show ip route&quot;</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

        <span class="n">routes</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">dynamic_routes</span><span class="o">.</span><span class="n">scrapli_response</span><span class="o">.</span><span class="n">textfsm_parse_output</span><span class="p">():</span>
                <span class="k">if</span> <span class="s2">&quot;O&quot;</span> <span class="ow">in</span> <span class="n">route</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;D&quot;</span> <span class="ow">in</span> <span class="n">route</span><span class="p">[</span><span class="s1">&#39;protocol&#39;</span><span class="p">]:</span>
                    <span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">route</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">route</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">interface_parser</span> <span class="o">=</span> <span class="n">ParseConfig</span><span class="p">(</span><span class="n">connect_routes</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">temp</span><span class="o">=</span><span class="s2">&quot;interfaces&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interface_parser</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;address&quot;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ip_address</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">.</span><span class="n">is_private</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">route</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">network</span>
                    <span class="n">route</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">route</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">convert_to_cidr</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">static_route</span> <span class="ow">in</span> <span class="n">static_routes</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">static_route</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">network</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">subnet</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">route</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">network</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">convert_to_cidr</span><span class="p">(</span><span class="n">subnet</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">network</span> <span class="o">!=</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">:</span>
                <span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">routes</span>

    <span class="c1"># For fortigate</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;generic&quot;</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config_commands</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forigate advpn config&#39;</span><span class="p">,</span>
                    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;config system console&quot;</span><span class="p">,</span><span class="s2">&quot;set output standard&quot;</span> <span class="p">,</span><span class="s2">&quot;end&quot;</span><span class="p">])</span>

        <span class="n">connect_routes</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;get system interface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="n">interface_parser</span> <span class="o">=</span> <span class="n">ForigateParser</span><span class="p">(</span><span class="n">connect_routes</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;interface_attr&quot;</span><span class="p">)</span>

        <span class="n">routes</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interface_parser</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ip&quot;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ip</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;169.254&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ip</span> <span class="ow">and</span> <span class="s2">&quot;0.0.0.0&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ip</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ip_address</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span><span class="o">.</span><span class="n">is_private</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">route</span> <span class="o">=</span> <span class="n">IPNetwork</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mask</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">network</span>
                    <span class="n">route</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">route</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">convert_to_cidr</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">routes</span></div>






<div class="viewcode-block" id="fetch_interface_info"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.fetch_interface_info">[docs]</a><span class="k">def</span> <span class="nf">fetch_interface_info</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function return the &#39;Show ip interface brief&#39; output</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;junos&quot;</span><span class="p">:</span>
        <span class="n">get_interfaces</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                            <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;show interfaces terse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

        <span class="n">interfaces</span> <span class="o">=</span> <span class="n">JuniperParser</span><span class="p">(</span><span class="n">get_interfaces</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;front_intf&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">intf_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="p">:</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extra&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="n">extra</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
            
            <span class="n">interface</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ip&#39;</span><span class="p">:</span><span class="n">ip</span><span class="p">})</span>
            <span class="n">intf_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">intf_info</span>



    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;ios&quot;</span><span class="p">:</span>
        <span class="n">interfaces</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show ip interface brief&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">scrapli_response</span><span class="o">.</span><span class="n">textfsm_parse_output</span><span class="p">()</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interfaces</span>


    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;generic&quot;</span><span class="p">:</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config_commands</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;set console length&#39;</span><span class="p">,</span>
                <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;config system console&quot;</span><span class="p">,</span><span class="s2">&quot;set output standard&quot;</span> <span class="p">,</span><span class="s2">&quot;end&quot;</span><span class="p">])</span>

        <span class="n">raw_interfaces</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="s2">&quot;get system interface&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
        <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span>

        <span class="n">raw_interfaces</span> <span class="o">=</span> <span class="n">ForigateParser</span><span class="p">(</span><span class="n">raw_interfaces</span><span class="p">)</span><span class="o">.</span><span class="n">get_parsed</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="s2">&quot;txtfsm_struct_intf&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>


        <span class="n">interfaces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">raw_interfaces</span><span class="p">:</span>
            <span class="n">intf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
            <span class="n">intf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;extras&quot;</span><span class="p">)</span>
            <span class="n">intf</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span>
            <span class="n">interfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intf</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">interfaces</span></div>



<div class="viewcode-block" id="fortigate_neighbors"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.fortigate_neighbors">[docs]</a><span class="k">def</span> <span class="nf">fortigate_neighbors</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">get_prompt</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;get vpn ipsec tunnel details | grep remote-gateway&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

    <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">tunnel</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tunnel</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tunnel</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">neighbors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">neighbors</span></div>



<div class="viewcode-block" id="juniper_neighbors"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.juniper_neighbors">[docs]</a><span class="k">def</span> <span class="nf">juniper_neighbors</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_send</span><span class="p">,</span>
                <span class="n">command</span><span class="o">=</span><span class="s2">&quot;show security ike security-associations | grep IKE&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>

    <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[</span><span class="n">nei</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">nei</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nei</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">]</span>
    <span class="k">return</span> <span class="n">neighbors</span></div>



<div class="viewcode-block" id="change_ipsec_keys"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.change_ipsec_keys">[docs]</a><span class="k">def</span> <span class="nf">change_ipsec_keys</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="n">new_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function for changing IPsec keys (Cisco)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;access_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">cmds</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;no crypto isakmp key </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ipsec_key&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> address 0.0.0.0&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;crypto isakmp key </span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s1"> address 0.0.0.0&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;access_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;HUB&quot;</span><span class="p">:</span>
            <span class="n">cmds</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;no crypto isakmp key  </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ipsec_key&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> address 0.0.0.0&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;crypto isakmp key </span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s1"> address 0.0.0.0&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SPOKE&quot;</span><span class="p">:</span>
            <span class="n">cmds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;crypto keyring DMVPN vrf INTERNET&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;no pre-shared-key address 0.0.0.0 0.0.0.0 key  </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;ipsec_key&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">,</span><span class="sa">f</span><span class="s2">&quot;pre-shared-key address 0.0.0.0 0.0.0.0 key </span><span class="si">{</span><span class="n">new_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
            <span class="n">configs</span><span class="o">=</span><span class="n">cmds</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>






<div class="viewcode-block" id="configure_logging"><a class="viewcode-back" href="../../../api.nornir_stuff.html#api.nornir_stuff.configure_nodes.configure_logging">[docs]</a><span class="k">def</span> <span class="nf">configure_logging</span><span class="p">(</span><span class="n">task</span><span class="p">,</span><span class="n">logging_host</span><span class="p">,</span><span class="n">logging_level</span><span class="p">,</span><span class="n">facility</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    function for configuring logging on cisco devices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parse_template</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">text</span><span class="o">.</span><span class="n">template_file</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Configure Logging&quot;</span><span class="p">,</span>
                        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;logging.jinja2&quot;</span><span class="p">,</span>
                        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;api/nornir_stuff/templates/cisco/&quot;</span><span class="p">,</span>
                        <span class="n">logging_host</span><span class="o">=</span><span class="n">logging_host</span><span class="p">,</span>
                        <span class="n">logging_level</span><span class="o">=</span><span class="n">logging_level</span><span class="p">,</span>
                        <span class="n">facility</span><span class="o">=</span><span class="n">facility</span><span class="p">)</span>

    <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parse_template</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]</span>

    <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">scrape_config</span><span class="p">,</span>
            <span class="n">configs</span><span class="o">=</span><span class="n">cmds</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">host</span><span class="o">.</span><span class="n">close_connection</span><span class="p">(</span><span class="s2">&quot;scrapli&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Uurnik Systems.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>